{% load staticfiles %}
<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/codemirror.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/codemirror.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/addon/search/searchcursor.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/addon/selection/mark-selection.js"></script>

        <link rel="stylesheet" href='{% static "css/web.css" %}'>
    </head>
    <body>
        <div class="github-buttons">
            <div class="buttons">
                <a class="github-button" href="https://github.com/Singapore-Tech-Entrepreneurs/XComment.io" data-icon="octicon-star" data-size="large" aria-label="Star Singapore-Tech-Entrepreneurs/XComment.io on GitHub">Star</a>
                <a class="github-button" href="https://github.com/Singapore-Tech-Entrepreneurs/XComment.io/fork" data-icon="octicon-repo-forked" data-size="large" aria-label="Fork Singapore-Tech-Entrepreneurs/XComment.io on GitHub">Fork</a>
            </div>
        </div>
        <form method="POST" action="/" name="form" novalidate> {% csrf_token %}
            <div class="editor">
                <p>Original</p>
                {{form.source_content}}
            </div>
            <div class="bridge">
                <div class="bridge-content">
                    <p><em>Select Language</em></p>
                    {{form.language}}
                    <br/>
                    <br/>
                    <br/>
                    <button type="submit" name="remove">
                        Remove comments
                    </button>
                </div>
            </div>
        </form>

        <div class="editor">
            <p>Cleaned Code</p>
            {{form.results_content}}
        </div>

        <script async defer src="https://buttons.github.io/buttons.js"></script>
        <script src='{% static "js/highlight.pack.js" %}'></script>
        <script>
    window.onload = function() {
        var supported_langs = {{language_choices | safe }};

        function highlightJsChoicesMap(key) {
            let _map = {
                cpp: 'c',
                armasm: 'assembly',
                cs: 'csharp'
            }

            if(key in _map) {
                return _map[key];
            } else {
                return key;
            }
        }

        function makeEditor(textField) {
            let editor = CodeMirror.fromTextArea(textField, {
                lineNumbers: true,
                lineWrapping: true,
                styleSelectedText: true
            });
            editor.setSize(null, "100%");
            return editor;
        }

        function highlightComments(editor) {
            let cursor, searchTerm;

            {% for each in highlight_content %}
                searchTerm = "{{each | escapejs}}";
                cursor = editor.getSearchCursor(searchTerm)
                while(cursor.findNext()) {
                    editor.markText(
                        cursor.from(), cursor.to(), {className: "styled-background"});
                }
            {% endfor %}
        }

        function getMode(sourceContent) {
            let lang = hljs.highlightAuto(sourceContent).language;
            let mode = "javascript";
            mapped_lang_choice = highlightJsChoicesMap(lang);
            if(mapped_lang_choice in supported_langs && typeof lang != 'undefined') {
                mode = supported_langs[mapped_lang_choice];
            }
            return [mode, mapped_lang_choice];
        }

        function loadMode(mode, onLoadFn) {
            let script = document.createElement('script');
            script.onload = onLoadFn;
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/mode/" + mode +"/" + mode + ".js";
            document.body.appendChild(script);
        }

        function highlightCode(editor, mode) {
            editor.setOption("mode", mode);
        }

        function selectLangChoice(selectorNode, selected) {
            selectorNode.value = selected;
        }

        let source = document.getElementById('id_source_content');
        let results = document.getElementById('id_results_content');
        let sourceEditor = makeEditor(source);
        let resultsEditor = makeEditor(results);
        let selectorNode = document.getElementById('id_language');
        let mode_lang_choice = getMode(source.textContent);
        let mode = mode_lang_choice[0];
        let lang_choice = mode_lang_choice[1];

        loadMode(mode, function() {
            highlightCode(sourceEditor, mode);
            highlightCode(resultsEditor, mode);
        });
        sourceEditor.on('change', function(editor, change) {
            doc = editor.getDoc();
            mode_lang_choice = getMode(doc.getValue());
            mode = mode_lang_choice[0];
            lang_choice = mode_lang_choice[1];
            loadMode(mode, function() {
                highlightCode(editor, mode);
                highlightCode(resultsEditor, mode);
                selectLangChoice(selectorNode, lang_choice);
            });
        });
        highlightComments(sourceEditor);
        selectorNode.onchange = function() {
            mode = supported_langs[selectorNode.value];
            loadMode(mode, function() {
                highlightCode(sourceEditor, mode);
                highlightCode(resultsEditor, mode);
            });
        }
    }
        </script>
    </body>
</html>
